{% extends 'analisador/base.html' %}

{% block title %}Relatório: {{ extrato.mes_referencia }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h1 class="h2 mb-0"><i class="bi bi-file-earmark-text me-3"></i>Relatório: {{ extrato.mes_referencia }}</h1>
        <div>
            <a href="{% url 'historico' %}" class="btn btn-secondary">Ver Histórico</a>
            <a href="{% url 'home' %}" class="btn btn-info">Analisar Outro Extrato</a>
        </div>
    </div>
    
        <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0"><i class="bi bi-funnel"></i> Filtros</h2>
        </div>
        <div class="card-body">
            <form method="GET" action="">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="q" class="form-label">Buscar na Descrição:</label>
                        <input type="text" name="q" id="q" class="form-control" value="{{ search_query|default:'' }}" placeholder="Ex: Mercado">
                    </div>
                    <div class="col-md-3">
                        <label for="data_inicio" class="form-label">De:</label>
                        <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="data_fim" class="form-label">Até:</label>
                        <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim|default:'' }}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Resumo Geral</h2>
        </div>
        <div class="card-body">
            <p><strong>Receita Total:</strong> R$ {{ total_receitas }}</p>
            <p><strong>Despesa Total:</strong> R$ {{ total_despesas }}</p>
            <hr>
            <p><strong>Saldo Líquido:</strong> R$ {{ saldo_liquido }}</p>
        </div>
    </div>

    <!-- Gráfico -->
<div class="card mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Despesas por Categoria (Gráfico)</h2>
    </div>
    <div class="card-body">
        <!-- A classe .chart-container agora está em uma div interna -->
        <div class="chart-container">
            <canvas id="graficoDespesas"></canvas>
        </div>
    </div>
</div>

    <!-- Detalhamento de Despesas -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Detalhamento de Despesas por Categoria</h2>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <tbody>
                    {% for index, linha in resumo_despesas.iterrows %}
                    <tr>
                        <td>
                            <a href="{% url 'detalhe_categoria' extrato_id=extrato.id nome_categoria=linha.Subtópico %}">
                                {{ linha.Subtópico }}
                            </a>
                        </td>
                        <td class="text-end font-monospace valor-despesa">R$ {{ linha.Valor|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                                <tfoot>
                <tr class="table-group-divider"> <td class="valor-despesa">Total Despesas</td>
                    <td class="text-end font-monospace  valor-despesa">
                        R$ {{ valor_total_despesas_detalhe|floatformat:2 }}
                    </td>
                </tr>
            </tfoot>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detalhamento de Receitas -->
<div class="card mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Detalhamento de Receitas por Categoria</h2>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <tbody>
                {% for index, linha in resumo_receitas.iterrows %}
                <tr>
                    <td>
                        <!-- A MESMA LÓGICA DE LINK DAS DESPESAS, APLICADA AQUI -->
                        <a href="{% url 'detalhe_categoria' extrato_id=extrato.id nome_categoria=linha.Subtópico %}">
                            {{ linha.Subtópico }}
                        </a>
                    </td>
                    <td class="text-end font-monospace valor-receita">R$ {{ linha.Valor|floatformat:2 }}</td>
                </tr>
                {% endfor %}
                                                <tfoot>
                <tr class="table-group-divider"> <td class="valor-receita">Total Despesas</td>
                    <td class="text-end font-monospace  valor-receita">
                        R$ {{ valor_total_despesas_detalhe|floatformat:2 }}
                    </td>
                </tr>
            </tfoot>
            </tbody>
        </table>
    </div>
</div>
<div class="card mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Transações Não Categorizadas</h2>
    </div>
    <div class="card-body">
        <p>Crie regras para as transações abaixo:</p>
        
        {% if not nao_categorizadas.empty %}
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Tópico</th>
                        <th>Data</th>
                        <th>Remetente/Destinatário</th>
                        <th class="text-end">Valor</th>
                        <th style="width: 30%;">Ação Rápida (Criar Regra)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for index, linha in nao_categorizadas.iterrows %}
                    <tr>
                        <td>{{ linha.Tópico }}</td>
                        <td>{{ linha.Data }}</td>
                        <td>{{ linha.Remetente_Destinatario }}</td>
                            <td class="text-end font-monospace {% if linha.Tópico == 'Despesa' %}valor-despesa{% elif linha.Tópico == 'Receita' %}valor-receita{% endif %}">
                            R$ {{ linha.Valor|floatformat:2 }}
                        </td>
                        <td>
                            <!-- Pequeno formulário para cada linha -->
                            <form action="{% url 'criar_regra_rapida' %}" method="POST" class="d-flex">
                                {% csrf_token %}
                                <!-- Campos escondidos que enviam informações importantes -->
                                <input type="hidden" name="palavra_chave" value="{{ linha.Remetente_Destinatario }}">
                                <input type="hidden" name="extrato_id" value="{{ extrato.id }}">
                                
                                <!-- Campo visível para o usuário digitar a categoria -->
                                <input type="text" name="categoria" class="form-control form-control-sm me-2" placeholder="Digite a categoria" required>
                                <button type="submit" class="btn btn-sm btn-primary">Salvar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Parabéns! Todas as suas transações foram categorizadas.</p>
        {% endif %}
    </div>
</div>


    <script>
    const ctx = document.getElementById('graficoDespesas');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ labels_grafico|safe }},
            datasets: [{
            label: 'Despesas por Categoria (R$)',
            data: {{ dados_grafico|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
            }]
        },
        options: {
            scales: {
            y: {
                beginAtZero: true
            }
            }
        }
    });
    </script>
{% endblock %}
